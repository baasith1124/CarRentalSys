@model CarRentalSystem.Web.ViewModels.CarOwner.CarOwnerDashboardViewModel

@{
    ViewData["Title"] = "Car Owner Dashboard";
    Layout = "~/Views/Shared/_CarOwnerLayout.cshtml";
}

<div class="car-owner-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="dashboard-title">
                    <i class="bi bi-car-front-fill"></i>
                    Car Owner Dashboard
                </h1>
                <p class="dashboard-subtitle">Manage your cars and track your earnings</p>
            </div>
            <div class="dashboard-actions">
                <a asp-action="RegisterCar" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add New Car
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stats-card earnings">
                <div class="stats-icon">
                    <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stats-content">
                    <h3>$@Model.TotalEarnings.ToString("N0")</h3>
                    <p>Total Earnings</p>
                    <small>All time</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card bookings">
                <div class="stats-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stats-content">
                    <h3>@Model.TotalBookings</h3>
                    <p>Total Bookings</p>
                    <small>All time</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card active-cars">
                <div class="stats-icon">
                    <i class="bi bi-car-front"></i>
                </div>
                <div class="stats-content">
                    <h3>@Model.ActiveCars</h3>
                    <p>Active Cars</p>
                    <small>Available for rent</small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card pending-cars">
                <div class="stats-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stats-content">
                    <h3>@Model.PendingCars</h3>
                    <p>Pending Approval</p>
                    <small>Awaiting review</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card quick-actions-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning"></i> Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a asp-action="RegisterCar" class="quick-action-btn">
                                <div class="quick-action-icon">
                                    <i class="bi bi-plus-circle"></i>
                                </div>
                                <div class="quick-action-content">
                                    <h6>Add New Car</h6>
                                    <small>Register a new vehicle</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="Cars" class="quick-action-btn">
                                <div class="quick-action-icon">
                                    <i class="bi bi-car-front"></i>
                                </div>
                                <div class="quick-action-content">
                                    <h6>Manage Cars</h6>
                                    <small>View and edit your cars</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="Bookings" class="quick-action-btn">
                                <div class="quick-action-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="quick-action-content">
                                    <h6>View Bookings</h6>
                                    <small>Manage reservations</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a asp-action="Earnings" class="quick-action-btn">
                                <div class="quick-action-icon">
                                    <i class="bi bi-graph-up"></i>
                                </div>
                                <div class="quick-action-content">
                                    <h6>View Earnings</h6>
                                    <small>Track your income</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row g-4">
        <!-- My Cars -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-car-front text-primary"></i>
                        My Cars
                    </h5>
                    <a asp-action="Cars" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body">
                    @if (Model.MyCars.Any())
                    {
                        <div class="cars-grid">
                            @foreach (var car in Model.MyCars.Take(4))
                            {
                                <div class="car-card">
                                    <div class="car-image">
                                        @if (!string.IsNullOrEmpty(car.ImagePath))
                                        {
                                            <img src="@car.ImagePath" alt="@car.Name" class="car-thumbnail">
                                        }
                                        else
                                        {
                                            <div class="car-placeholder">
                                                <i class="bi bi-car-front"></i>
                                            </div>
                                        }
                                        <div class="car-status">
                                            @if (car.CarApprovalStatus == "Approved")
                                            {
                                                <span class="badge bg-success">Approved</span>
                                            }
                                            else if (car.CarApprovalStatus == "Pending")
                                            {
                                                <span class="badge bg-warning">Pending</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Rejected</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="car-info">
                                        <h6 class="car-name">@car.Name @car.Model</h6>
                                        <p class="car-rate">$@car.RatePerDay/day</p>
                                        <div class="car-details">
                                            <small class="text-muted">
                                                @car.Year • @car.Transmission • @car.FuelType
                                            </small>
                                        </div>
                                    </div>
                                    <div class="car-actions">
                                        <a asp-action="EditCar" asp-route-carId="@car.CarId" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteCar('@car.CarId')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No Cars Registered</h5>
                            <p class="text-muted">Start by adding your first car to begin earning</p>
                            <a asp-action="RegisterCar" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Add Your First Car
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Recent Bookings -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar-check text-success"></i>
                        Recent Bookings
                    </h5>
                    <a asp-action="Bookings" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body">
                    @if (Model.RecentBookings.Any())
                    {
                        <div class="bookings-list">
                            @foreach (var booking in Model.RecentBookings)
                            {
                                <div class="booking-item">
                                    <div class="booking-info">
                                        <h6 class="booking-car">@booking.CarName</h6>
                                        <small class="text-muted">
                                            @booking.PickupDate.ToString("MMM dd") - @booking.ReturnDate.ToString("MMM dd")
                                        </small>
                                        <div class="booking-customer">
                                            <small>Customer: @booking.CustomerName</small>
                                        </div>
                                    </div>
                                    <div class="booking-amount">
                                        <strong>$@booking.TotalCost</strong>
                                        <div class="booking-status">
                                            @if (booking.PaymentStatus == "Paid")
                                            {
                                                <span class="badge bg-success">Paid</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Pending</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="bi bi-calendar-x text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">No bookings yet</p>
                        </div>
                    }
                </div>
            </div>
            
            <!-- Earnings Chart -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart text-primary"></i>
                        Monthly Earnings
                    </h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="earningsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Car Modal -->
<div class="modal fade" id="deleteCarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this car? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteCarForm" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">Delete Car</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize car owner dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCarOwnerCharts();
        });
        
        function initCarOwnerCharts() {
            // Earnings Chart
            const earningsCtx = document.getElementById('earningsChart');
            if (earningsCtx) {
                const currentMonth = new Date().getMonth();
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const totalEarnings = @Model.TotalEarnings;
                
                // Generate sample monthly data based on total earnings
                const monthlyData = [];
                for (let i = 0; i < 6; i++) {
                    const monthIndex = (currentMonth - 5 + i + 12) % 12;
                    const baseAmount = totalEarnings / 6;
                    const variation = (Math.random() - 0.5) * baseAmount * 0.4;
                    monthlyData.push(Math.max(0, baseAmount + variation));
                }
                
                const last6Months = [];
                for (let i = 5; i >= 0; i--) {
                    const monthIndex = (currentMonth - i + 12) % 12;
                    last6Months.push(months[monthIndex]);
                }
                
                new Chart(earningsCtx, {
                    type: 'line',
                    data: {
                        labels: last6Months,
                        datasets: [{
                            label: 'Earnings ($)',
                            data: monthlyData,
                            fill: true,
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 3,
                            pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return 'Earnings: $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function deleteCar(carId) {
            const form = document.getElementById('deleteCarForm');
            form.action = `/CarOwner/Cars/Delete/${carId}`;
            new bootstrap.Modal(document.getElementById('deleteCarModal')).show();
        }
    </script>
}
