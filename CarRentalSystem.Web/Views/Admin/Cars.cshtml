@model CarRentalSystem.Web.ViewModels.Admin.CarManagementViewModel

@{
    ViewData["Title"] = "Car Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="car-management">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="page-title">
                <i class="bi bi-car-front"></i>
                Car Management
            </h2>
            <p class="text-muted">Manage car approvals and listings</p>
        </div>
        <div class="header-actions">
            <a asp-action="AddCar" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Add New Car
            </a>
            <button class="btn btn-outline-primary" onclick="refreshPage()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stats-summary pending">
                <div class="stats-icon">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="stats-info">
                    <h4>@Model.PendingCars.Count</h4>
                    <p>Pending Approval</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-summary approved">
                <div class="stats-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stats-info">
                    <h4>@Model.ApprovedCars.Count</h4>
                    <p>Approved Cars</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-summary rejected">
                <div class="stats-icon">
                    <i class="bi bi-x-circle"></i>
                </div>
                <div class="stats-info">
                    <h4>@Model.RejectedCars.Count</h4>
                    <p>Rejected Cars</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="carTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                <i class="bi bi-clock-history"></i> Pending (@Model.PendingCars.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="approved-tab" data-bs-toggle="tab" data-bs-target="#approved" type="button" role="tab">
                <i class="bi bi-check-circle"></i> Approved (@Model.ApprovedCars.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                <i class="bi bi-x-circle"></i> Rejected (@Model.RejectedCars.Count)
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="carTabsContent">
        <!-- Pending Cars -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    @if (Model.PendingCars.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Car Details</th>
                                        <th>Owner</th>
                                        <th>Rate/Day</th>
                                        <th>Availability</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var car in Model.PendingCars)
                                    {
                                        <tr>
                                            <td>
                                                <div class="car-info">
                                                    <div class="car-image">
                                                        <img src="@(!string.IsNullOrEmpty(car.ImagePath) ? $"/images/cars/{car.ImagePath}" : "/images/default-car.jpg")" 
                                                             alt="@car.Name" 
                                                             class="car-thumbnail"
                                                             onerror="this.src='/images/default-car.jpg'" />
                                                    </div>
                                                    <div class="car-details">
                                                        <h6 class="car-name">@car.Name @car.Model</h6>
                                                        <small class="text-muted">
                                                            @car.Year • @car.Transmission • @car.FuelType
                                                        </small>
                                                        @if (!string.IsNullOrEmpty(car.Description))
                                                        {
                                                            <p class="car-description">@car.Description</p>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="owner-info">
                                                    <strong>@car.OwnerName</strong>
                                                    <br>
                                                    <small class="text-muted">@car.OwnerEmail</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="rate-badge">$@car.RatePerDay</span>
                                            </td>
                                            <td>
                                                <div class="availability-info">
                                                    <small>
                                                        <strong>From:</strong> @car.AvailableFrom.ToString("MMM dd, yyyy")<br>
                                                        <strong>To:</strong> @car.AvailableTo.ToString("MMM dd, yyyy")
                                                    </small>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <form asp-action="ApproveCar" asp-route-carId="@car.CarId" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-success btn-sm" title="Approve">
                                                            <i class="bi bi-check"></i>
                                                        </button>
                                                    </form>
                                                    <form asp-action="RejectCar" asp-route-carId="@car.CarId" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-danger btn-sm" title="Reject">
                                                            <i class="bi bi-x"></i>
                                                        </button>
                                                    </form>
                                                    <a asp-action="EditCar" asp-route-carId="@car.CarId" class="btn btn-warning btn-sm" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewCarDetails('@car.CarId')" title="View Details">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <form asp-action="DeleteCar" asp-route-carId="@car.CarId" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this car? This action cannot be undone.')" title="Delete">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No Pending Cars</h5>
                            <p class="text-muted">All cars have been reviewed</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Approved Cars -->
        <div class="tab-pane fade" id="approved" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    @if (Model.ApprovedCars.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Car Details</th>
                                        <th>Owner</th>
                                        <th>Rate/Day</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var car in Model.ApprovedCars)
                                    {
                                        <tr>
                                            <td>
                                                <div class="car-info">
                                                    <div class="car-image">
                                                        <img src="@(!string.IsNullOrEmpty(car.ImagePath) ? $"/images/cars/{car.ImagePath}" : "/images/default-car.jpg")" 
                                                             alt="@car.Name" 
                                                             class="car-thumbnail"
                                                             onerror="this.src='/images/default-car.jpg'" />
                                                    </div>
                                                    <div class="car-details">
                                                        <h6 class="car-name">@car.Name @car.Model</h6>
                                                        <small class="text-muted">
                                                            @car.Year • @car.Transmission • @car.FuelType
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="owner-info">
                                                    <strong>@car.OwnerName</strong>
                                                    <br>
                                                    <small class="text-muted">@car.OwnerEmail</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="rate-badge">$@car.RatePerDay</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">Approved</span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a asp-action="EditCar" asp-route-carId="@car.CarId" class="btn btn-warning btn-sm" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewCarDetails('@car.CarId')" title="View Details">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <form asp-action="DeleteCar" asp-route-carId="@car.CarId" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this car? This action cannot be undone.')" title="Delete">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No Approved Cars</h5>
                            <p class="text-muted">No cars have been approved yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Rejected Cars -->
        <div class="tab-pane fade" id="rejected" role="tabpanel">
            <div class="card mt-3">
                <div class="card-body">
                    @if (Model.RejectedCars.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Car Details</th>
                                        <th>Owner</th>
                                        <th>Rate/Day</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var car in Model.RejectedCars)
                                    {
                                        <tr>
                                            <td>
                                                <div class="car-info">
                                                    <div class="car-image">
                                                        <img src="@(!string.IsNullOrEmpty(car.ImagePath) ? $"/images/cars/{car.ImagePath}" : "/images/default-car.jpg")" 
                                                             alt="@car.Name" 
                                                             class="car-thumbnail"
                                                             onerror="this.src='/images/default-car.jpg'" />
                                                    </div>
                                                    <div class="car-details">
                                                        <h6 class="car-name">@car.Name @car.Model</h6>
                                                        <small class="text-muted">
                                                            @car.Year • @car.Transmission • @car.FuelType
                                                        </small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="owner-info">
                                                    <strong>@car.OwnerName</strong>
                                                    <br>
                                                    <small class="text-muted">@car.OwnerEmail</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="rate-badge">$@car.RatePerDay</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-danger">Rejected</span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <a asp-action="EditCar" asp-route-carId="@car.CarId" class="btn btn-warning btn-sm" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewCarDetails('@car.CarId')" title="View Details">
                                                        <i class="bi bi-eye"></i>
                                                    </button>
                                                    <form asp-action="DeleteCar" asp-route-carId="@car.CarId" method="post" class="d-inline">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this car? This action cannot be undone.')" title="Delete">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-x-circle text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">No Rejected Cars</h5>
                            <p class="text-muted">No cars have been rejected</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Car Details Modal -->
<div class="modal fade" id="carDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-car-front"></i> Car Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="carDetailsContent">
                <!-- Car details will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refreshPage() {
            location.reload();
        }

        function viewCarDetails(carId) {
            // Load car details via AJAX
            fetch(`/Admin/Cars/Details/${carId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('carDetailsContent').innerHTML = data.html;
                    new bootstrap.Modal(document.getElementById('carDetailsModal')).show();
                })
                .catch(error => {
                    console.error('Error loading car details:', error);
                    AdminPanel.showNotification('Error loading car details', 'error');
                });
        }


        // Initialize tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('#carTabs button[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function(e) {
                    // You can add any tab-specific functionality here
                });
            });
            
            // Debug car images
            console.log('Debugging car images...');
            var carImages = document.querySelectorAll('.car-thumbnail');
            carImages.forEach(function(img, index) {
                console.log(`Car image ${index + 1}:`, {
                    src: img.src,
                    alt: img.alt,
                    naturalWidth: img.naturalWidth,
                    naturalHeight: img.naturalHeight,
                    complete: img.complete
                });
                
                img.addEventListener('error', function() {
                    console.error(`Image failed to load: ${img.src}`);
                });
                
                img.addEventListener('load', function() {
                    console.log(`Image loaded successfully: ${img.src}`);
                });
            });
        });
    </script>
}
