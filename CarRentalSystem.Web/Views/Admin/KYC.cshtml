@model List<CarRentalSystem.Application.Contracts.KYC.KYCUploadDto>

@{
    ViewData["Title"] = "KYC Document Review";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="admin-dashboard-3d">
    <!-- Enhanced 3D Header -->
    <div class="dashboard-header-3d">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="dashboard-title-3d">
                    <div class="title-icon-3d">
                        <i class="bi bi-file-earmark-check"></i>
                        <div class="icon-glow-3d"></div>
                    </div>
                    KYC Document Review
                </h1>
                <p class="dashboard-subtitle-3d">Review and approve customer KYC documents</p>
            </div>
            <div class="dashboard-actions-3d">
                <button class="btn-3d-interactive btn-primary-3d" onclick="refreshPage()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Enhanced 3D Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="stats-card-3d total-3d">
                <div class="stats-icon-3d">
                    <i class="bi bi-file-earmark-text"></i>
                    <div class="icon-glow-3d"></div>
                </div>
                <div class="stats-content-3d">
                    <h3>@Model.Count</h3>
                    <p>Total KYC</p>
                    <small>All documents</small>
                </div>
                <div class="card-glow-3d"></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card-3d pending-3d">
                <div class="stats-icon-3d">
                    <i class="bi bi-clock-history"></i>
                    <div class="icon-glow-3d"></div>
                </div>
                <div class="stats-content-3d">
                    <h3>@Model.Count(k => k.Status == "Pending")</h3>
                    <p>Pending Review</p>
                    <small>Awaiting approval</small>
                </div>
                <div class="card-glow-3d"></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card-3d approved-3d">
                <div class="stats-icon-3d">
                    <i class="bi bi-check-circle"></i>
                    <div class="icon-glow-3d"></div>
                </div>
                <div class="stats-content-3d">
                    <h3>@Model.Count(k => k.Status == "Approved")</h3>
                    <p>Approved</p>
                    <small>Verified documents</small>
                </div>
                <div class="card-glow-3d"></div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stats-card-3d rejected-3d">
                <div class="stats-icon-3d">
                    <i class="bi bi-x-circle"></i>
                    <div class="icon-glow-3d"></div>
                </div>
                <div class="stats-content-3d">
                    <h3>@Model.Count(k => k.Status == "Rejected")</h3>
                    <p>Rejected</p>
                    <small>Declined documents</small>
                </div>
                <div class="card-glow-3d"></div>
            </div>
        </div>
    </div>

    <!-- Enhanced 3D Search and Filter -->
    <div class="card-3d-interactive mb-4">
        <div class="card-header-3d">
            <h5 class="card-title-3d mb-0">
                <div class="title-icon-3d">
                    <i class="bi bi-funnel"></i>
                    <div class="icon-glow-3d"></div>
                </div>
                Search & Filter
            </h5>
        </div>
        <div class="card-body-3d">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="form-group-3d">
                        <label for="searchInput" class="form-label-3d">Search KYC</label>
                        <input type="text" id="searchInput" class="form-control-3d" placeholder="Search by customer name or email...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group-3d">
                        <label for="statusFilter" class="form-label-3d">Status</label>
                        <select id="statusFilter" class="form-select-3d">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group-3d">
                        <label for="documentTypeFilter" class="form-label-3d">Document Type</label>
                        <select id="documentTypeFilter" class="form-select-3d">
                            <option value="">All Types</option>
                            <option value="NIC">National ID (NIC)</option>
                            <option value="Passport">Passport</option>
                            <option value="Driving License">Driving License</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group-3d">
                        <label class="form-label-3d">&nbsp;</label>
                        <button class="btn-3d-interactive btn-primary-3d w-100" onclick="applyFilters()">
                            <i class="bi bi-funnel"></i>
                            <span>Filter</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-glow-3d"></div>
    </div>

    <!-- Enhanced 3D KYC Documents List -->
    <div class="card-3d-interactive">
        <div class="card-header-3d">
            <h5 class="card-title-3d mb-0">
                <div class="title-icon-3d">
                    <i class="bi bi-table"></i>
                    <div class="icon-glow-3d"></div>
                </div>
                KYC Documents
            </h5>
        </div>
        <div class="card-body-3d">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover table-3d" id="kycTable">
                        <thead class="table-header-3d">
                            <tr>
                                <th><i class="bi bi-person me-2"></i>Customer Details</th>
                                <th><i class="bi bi-file-earmark me-2"></i>Document Information</th>
                                <th><i class="bi bi-calendar me-2"></i>Upload Date</th>
                                <th><i class="bi bi-flag me-2"></i>Status</th>
                                <th><i class="bi bi-gear me-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kyc in Model)
                            {
                                <tr data-kyc-id="@kyc.Id">
                                    <td>
                                        <div class="customer-info">
                                            <div class="customer-name">
                                                <strong>@kyc.UserName</strong>
                                            </div>
                                            <small class="text-muted">@kyc.UserEmail</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="document-info">
                                            <div class="document-type">
                                                <strong>@kyc.DocumentType</strong>
                                            </div>
                                            @if (!string.IsNullOrEmpty(kyc.FilePath))
                                            {
                                                <div class="document-preview mt-2">
                                                    <a href="/Admin/KYC/View/@kyc.Id" target="_blank" class="btn btn-outline-info btn-sm" title="View Document">
                                                        <i class="bi bi-eye"></i> View Document
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="upload-info">
                                            <div class="upload-date">
                                                <strong>@kyc.UploadedAt.ToString("MMM dd, yyyy")</strong>
                                            </div>
                                            <small class="text-muted">@kyc.UploadedAt.ToString("HH:mm")</small>
                                        </div>
                                    </td>
                                    <td>
                                        @{
                                            var statusClass = kyc.Status switch
                                            {
                                                "Pending" => "warning",
                                                "Approved" => "success",
                                                "Rejected" => "danger",
                                                _ => "secondary"
                                            };
                                        }
                                        <span class="badge bg-@statusClass">@kyc.Status</span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            @if (kyc.Status == "Pending")
                                            {
                                                <form asp-controller="Admin" asp-action="ApproveKYC" asp-route-kycId="@kyc.Id" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn-3d-interactive btn-success-3d btn-sm" title="Approve">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                </form>
                                                <form asp-controller="Admin" asp-action="RejectKYC" asp-route-kycId="@kyc.Id" method="post" class="d-inline">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn-3d-interactive btn-danger-3d btn-sm" title="Reject">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </form>
                                            }
                                            <button type="button" class="btn-3d-interactive btn-outline-primary-3d btn-sm" onclick="viewKYCDetails('@kyc.Id')" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="empty-state-3d">
                        <div class="empty-icon-3d">
                            <i class="bi bi-file-earmark-check"></i>
                            <div class="icon-glow-3d"></div>
                        </div>
                        <h5 class="empty-title-3d">No KYC Documents Found</h5>
                        <p class="empty-subtitle-3d">No KYC documents have been uploaded yet</p>
                    </div>
                </div>
            }
        </div>
        <div class="card-glow-3d"></div>
    </div>
</div>

<!-- Enhanced 3D KYC Details Modal -->
<div class="modal fade" id="kycDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-3d">
            <div class="modal-header modal-header-3d">
                <h5 class="modal-title modal-title-3d">
                    <div class="title-icon-3d">
                        <i class="bi bi-file-earmark-check"></i>
                        <div class="icon-glow-3d"></div>
                    </div>
                    KYC Document Details
                </h5>
                <button type="button" class="btn-close btn-close-3d" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-body-3d" id="kycDetailsContent">
                <!-- KYC details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Enhanced 3D Document Preview Modal -->
<div class="modal fade" id="documentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content modal-3d">
            <div class="modal-header modal-header-3d">
                <h5 class="modal-title modal-title-3d">
                    <div class="title-icon-3d">
                        <i class="bi bi-file-earmark"></i>
                        <div class="icon-glow-3d"></div>
                    </div>
                    Document Preview
                </h5>
                <button type="button" class="btn-close btn-close-3d" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-body-3d" id="documentContent">
                <!-- Document will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function refreshPage() {
            location.reload();
        }

        function viewKYCDetails(kycId) {
            // Load KYC details via AJAX
            fetch(`/Admin/KYC/Details/${kycId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.html) {
                        document.getElementById('kycDetailsContent').innerHTML = data.html;
                        new bootstrap.Modal(document.getElementById('kycDetailsModal')).show();
                    } else {
                        console.error('Error loading KYC details:', data.error);
                        alert('Error loading KYC details');
                    }
                })
                .catch(error => {
                    console.error('Error loading KYC details:', error);
                    alert('Error loading KYC details');
                });
        }

        function viewDocument(kycId) {
            // Open document in new tab
            window.open(`/Admin/KYC/View/${kycId}`, '_blank');
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const documentTypeFilter = document.getElementById('documentTypeFilter').value;
            
            const rows = document.querySelectorAll('#kycTable tbody tr');
            
            rows.forEach(row => {
                const customerName = row.querySelector('.customer-name strong').textContent.toLowerCase();
                const customerEmail = row.querySelector('.customer-info small').textContent.toLowerCase();
                const status = row.querySelector('.badge').textContent;
                const documentType = row.querySelector('.document-type strong').textContent;
                
                let showRow = true;
                
                // Search filter
                if (searchTerm && !customerName.includes(searchTerm) && !customerEmail.includes(searchTerm)) {
                    showRow = false;
                }
                
                // Status filter
                if (statusFilter && status !== statusFilter) {
                    showRow = false;
                }
                
                // Document type filter
                if (documentTypeFilter && documentType !== documentTypeFilter) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Initialize search functionality
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('documentTypeFilter').addEventListener('change', applyFilters);

        // Add debugging for form submissions
        document.addEventListener('DOMContentLoaded', function() {
            console.log('KYC page loaded, setting up form listeners');
            
            // Find all approve and reject forms
            const approveForms = document.querySelectorAll('form[action*="ApproveKYC"]');
            const rejectForms = document.querySelectorAll('form[action*="RejectKYC"]');
            
            console.log('Found approve forms:', approveForms.length);
            console.log('Found reject forms:', rejectForms.length);
            
            approveForms.forEach((form, index) => {
                console.log(`Setting up approve form ${index}:`, form.action);
                form.addEventListener('submit', function(e) {
                    console.log('APPROVE FORM SUBMITTED!');
                    console.log('Form action:', form.action);
                    console.log('Form method:', form.method);
                    console.log('Form data:', new FormData(form));
                    
                    // Extract KYC ID from action URL
                    const kycIdMatch = form.action.match(/\/ApproveKYC\/([^\/\?]+)/);
                    if (kycIdMatch) {
                        console.log('KYC ID from URL:', kycIdMatch[1]);
                    }
                });
            });
            
            rejectForms.forEach((form, index) => {
                console.log(`Setting up reject form ${index}:`, form.action);
                form.addEventListener('submit', function(e) {
                    console.log('REJECT FORM SUBMITTED!');
                    console.log('Form action:', form.action);
                    console.log('Form method:', form.method);
                    console.log('Form data:', new FormData(form));
                    
                    // Extract KYC ID from action URL
                    const kycIdMatch = form.action.match(/\/RejectKYC\/([^\/\?]+)/);
                    if (kycIdMatch) {
                        console.log('KYC ID from URL:', kycIdMatch[1]);
                    }
                });
            });
        });
    </script>
}

@section Styles {
    <style>
        /* KYC Specific 3D Enhancements */
        .customer-info {
            min-width: 150px;
        }

        .customer-name {
            margin-bottom: 4px;
        }

        .document-info {
            min-width: 200px;
        }

        .document-type {
            margin-bottom: 4px;
        }

        .document-preview {
            margin-top: 8px;
        }

        .upload-info {
            min-width: 120px;
            text-align: center;
        }

        .upload-date {
            margin-bottom: 4px;
        }

        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        /* Enhanced 3D Table Styling - Dark Theme */
        .table-3d {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            color: #e0e0e0;
        }

        .table-header-3d {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table-header-3d th {
            border: none;
            padding: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-3d tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 40, 0.8);
        }

        .table-3d tbody tr:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .table-3d td {
            padding: 1rem;
            vertical-align: middle;
            color: #e0e0e0;
        }

        /* Enhanced 3D Form Controls - Dark Theme */
        .form-control-3d, .form-select-3d {
            background: rgba(40, 40, 40, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            color: #e0e0e0;
        }

        .form-control-3d:focus, .form-select-3d:focus {
            background: rgba(50, 50, 50, 0.95);
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            transform: scale(1.01);
            color: #e0e0e0;
        }

        .form-control-3d::placeholder {
            color: #888;
        }

        .form-label-3d {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 0.5rem;
        }

        /* Enhanced 3D Button Styling - Fixed Sizing */
        .btn-success-3d {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .btn-success-3d:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-success-3d:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(40, 167, 69, 0.3);
        }

        .btn-danger-3d {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
            border: none;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .btn-danger-3d:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .btn-danger-3d:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(220, 53, 69, 0.3);
        }

        .btn-outline-primary-3d {
            border: 2px solid #667eea;
            color: #667eea;
            background: transparent;
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .btn-outline-primary-3d:hover {
            background: #667eea;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-outline-primary-3d:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(102, 126, 234, 0.3);
        }

        /* Enhanced 3D Modal Styling - Dark Theme */
        .modal-3d {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header-3d {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1.5rem;
        }

        .modal-title-3d {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-body-3d {
            padding: 2rem;
            background: rgba(30, 30, 30, 0.95);
            color: #e0e0e0;
        }

        .btn-close-3d {
            filter: brightness(0) invert(1);
        }

        /* Enhanced 3D Empty State - Dark Theme */
        .empty-state-3d {
            padding: 3rem 2rem;
        }

        .empty-icon-3d {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            position: relative;
        }

        .empty-title-3d {
            color: #e0e0e0;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .empty-subtitle-3d {
            color: #888;
            margin: 0;
        }

        /* Dark Theme Text Colors */
        .customer-info, .document-info, .upload-info {
            color: #e0e0e0;
        }

        .customer-name, .document-type, .upload-date {
            color: #e0e0e0;
        }

        .text-muted {
            color: #888 !important;
        }
    </style>
}
